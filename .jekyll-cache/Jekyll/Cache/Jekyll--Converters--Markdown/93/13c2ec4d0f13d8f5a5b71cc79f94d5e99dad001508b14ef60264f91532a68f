I"Ê<p>Keepalivedå®ç°é«˜å¯ç”¨,ä¸»å¤‡åˆ‡æ¢,æ—¥å¿—é…ç½®</p>

<h2 id="keepalivedé«˜å¯ç”¨">keepalivedé«˜å¯ç”¨</h2>

<p>éœ€è¦æ ¹æ®è‡ªå·±çš„é…ç½®è¿›è¡Œä¿®æ”¹,æˆ‘è¿™è¾¹æ˜¯è‡ªå·±æ‰“çš„<a href="./2020-3-31-nginx-keepalived-builds">rpm</a>å®‰è£…çš„æ‰€ä»¥å°±è´´å‡ ä¸ªé…ç½®å°±okäº†</p>

<h3 id="master">master</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>global_defs <span class="o">{</span>
 router_id SERVER_1 <span class="c">#è·¯ç”±idå·ï¼Œä¸èƒ½é‡å¤</span>
<span class="o">}</span>
vrrp_script chk_server1 <span class="o">{</span> 
    script <span class="s2">"/chek.sh"</span> <span class="c">#æ‰§è¡Œè„šæœ¬</span>
    interval 2 <span class="c">#é—´éš”æ—¶é—´</span>
    weight <span class="nt">-40</span>  <span class="c"># #ä¼˜å…ˆçº§ï¼ˆå¦‚æœè„šæœ¬æ‰§è¡Œç»“æœä¸º0ï¼Œå¹¶ä¸”weighté…ç½®çš„å€¼å¤§äº0ï¼Œåˆ™æƒé‡ç›¸åº”çš„å¢åŠ ï¼Œå¦‚æœè„šæœ¬æ‰§è¡Œç»“æœé0ï¼Œå¹¶ä¸”weighté…ç½®çš„å€¼å°äº0ï¼Œåˆ™ä¼˜å…ˆçº§ç›¸åº”çš„å‡å°‘ï¼‰</span>
<span class="o">}</span>             
      
 vrrp_instance VI_1 <span class="o">{</span>
   state BACKUP <span class="c">#çŠ¶æ€ master/backup</span>
   interface ens33  <span class="c">#ç½‘å¡</span>
   virtual_router_id 55  <span class="c">#é›†ç¾¤idå¿…é¡»ä¸€è‡´</span>
   priority 100  <span class="c">#æƒé‡</span>
   advert_int 1 <span class="c">#ä¸»å¤‡é€šè®¯æ—¶é—´é—´éš”</span>
   authentication <span class="o">{</span>
     auth_type PASS
     auth_pass 1111 <span class="c">#è®¤è¯å·ï¼Œé›†ç¾¤ä¸­è¦ä¸€è‡´</span>
   <span class="o">}</span>
   virtual_ipaddress <span class="o">{</span>
     192.168.0.4/24 <span class="c">#ä½¿ç”¨çš„è™šæ‹Ÿip</span>
   <span class="o">}</span>
   track_script <span class="o">{</span> <span class="c">#è°ƒç”¨ä¸Šé¢å®šä¹‰çš„æ£€æŸ¥è„šæœ¬</span>
     chk_server1 
   <span class="o">}</span>

</code></pre></div></div>

<h3 id="backup">backup</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vrrp_instance VI_1 {
   state BACKUP 
   interface ens33
   virtual_router_id 55
   priority 99
   advert_int 1
   authentication {
     auth_type PASS
     auth_pass 1111
   }
   virtual_ipaddress {
     192.168.0.4/24
   }

</code></pre></div></div>

<h3 id="cheksh">chek.sh</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>
<span class="nv">A</span><span class="o">=</span><span class="sb">`</span>ps <span class="nt">-C</span> nginx <span class="nt">--no-header</span> |wc <span class="nt">-l</span><span class="sb">`</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$A</span> <span class="nt">-eq</span> 0 <span class="o">]</span>
<span class="k">then
    </span><span class="nb">exit </span>1
<span class="k">fi</span>
</code></pre></div></div>

<h2 id="æ—¥å¿—é…ç½®">æ—¥å¿—é…ç½®</h2>

<p>é»˜è®¤æ—¥å¿—åœ¨<strong>/var/log/messages</strong>é‡Œ å¯è¯»æ€§å¾ˆä½ éœ€è¦ä¿®æ”¹</p>

<p>ä¿®æ”¹<strong>/etc/sysconfig/keepalived</strong>  keepalivedå¯åŠ¨æ–‡ä»¶ æŒ‰è‡ªå·±å®‰è£…è·¯å¾„æ¥</p>

<p>æŠŠ<strong>KEEPALIVED_OPTIONS=â€-Dâ€</strong> ä¿®æ”¹ä¸ºï¼š<strong>KEEPALIVED_OPTIONS=â€-D -d -S 0â€</strong></p>

<p><img src="https://i.opsta.cn/keepalived/keepalived-log.png" alt="keepalived-log" /></p>

<p>å†ä¿®æ”¹<strong>/etc/rsyslog.conf</strong></p>

<p>æ·»åŠ    <strong>local0.*                                                /var/log/keepalived.log</strong></p>

<p><img src="https://i.opsta.cn/rsyslog/rsyslog-keepalived-log.png" alt="image-20200528105508482" /></p>

<p>ç›®å‰çš„æ—¥å¿—åœ¨:<strong>/var/log/keepalived.log</strong></p>

<h2 id="åˆ‡æ¢æˆåŠŸ">åˆ‡æ¢æˆåŠŸ</h2>

<p><strong>masteråˆ‡æ¢</strong></p>

<p><img src="https://i.opsta.cn/keepalived/keepalived-switch-master.png" alt="76" /></p>

<p><strong>buckupåˆ‡æ¢</strong></p>

<p><img src="https://i.opsta.cn/keepalived/keepalived-switch-buckup.png" alt="77" /></p>

<h2 id="å‚è€ƒ">å‚è€ƒ</h2>

<p><a href="http://www.linkops.cn/820.htm">keepalivedé…ç½®é«˜å¯ç”¨</a></p>
:ET